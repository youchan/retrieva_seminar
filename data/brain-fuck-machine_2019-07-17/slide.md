# Brainf\*ck machine

%subtitle: 〜作ってわかるCPUのしくみ(デコーダー編)〜

%author: Retrieva Engineer Casual Talk vol.2 大崎 瑶

![icon](youchan.jpg)

## whoami

* 名前
  - 大崎 瑶(よう)
* 略歴
  - 1990 - 1997 東京電機大学 工学部 電子工学科
  - 1998 - 2000 筑波大学 大学院 電子情報工学研究科 (工学修士了)
  - 2009 - 2014 株式会社アプレッソ
  - 2014 - 2017 株式会社ユビレジ
  - 2017/11 株式会社レトリバ 入社
* 趣味
  - お酒 🍶
  - プログラミング
    - 技術書の薄い本
  - 電子工作

![analog](analog.jpg)

## Brainf\*ck

* 難解プログラミング言語の一種
* 8つの命令だけから成る
* 少なくとも30000個の要素を持つバイトの配列
* チューリング完全

※ BF言語または単にBFと呼ぶことにします。

## Brainf\*ckの命令

| 命令 | 動作               |
|------|--------------------|
| >    | `ptr++;`           |
| <    | `ptr--;`           |
| +    | `(*ptr)++`         |
| -    | `(*ptr)--`         |
| .    | `putchar(*ptr)`    |
| ,    | `*ptr = getchar()` |
| [    | `while (*ptr) {`   |
| ]    | `}`                |


## CPUの創りかた

![portlait-left](cpu.jpeg)

%right:

* TTLロジックICでCPUをつくる
* 4bit CPU: TD4
* ラーメンタイマーがつくれる!

## Brainf\*ck machine

* プリミティブな命令(CPU命令くらいのレベル)しかない
* 8命令しかない
* TD4の工作の難しさを解消するアイデアがある

---

%large: 同様の手法でBrainf\*ck machineつくれるんじゃないの？

## TD4の工作の難しさを解消

![portlait-right](TD4CPU.JPG)

%left:

* メモリをマイコンで代用
* ブレッドボードで実装

※  【写真】:弊社エンジニア岩田さん提供

## 仕様

|            | BF-Machine                     | TD4     |
|------------|--------------------------------|---------|
|            | 8bit                           | 4bit    |
| レジスタ数 | 5                              | 4       |
| 命令数     | 11(内部命令)                   | 12      |
| メモリ     | 命令、データ、ジャンプテーブル | 命令ROM |

## ブロックダイアグラム

![large](block-diagram.png)


## メモリの実装

* TD4ではROMをディップスイッチで実現
* BF machineではR/W出来るメモリが必要
* Arduinoでメモリを代用

## 命令フェッチ

---

%large: 各命令の実装

## `<` `>`

1. データポインタをインクリメント、デクリメント

## アップダウンカウンタ

* 74HC191
* TD4では74HC161というアップカウンタを使っている

## `+` `-`

1. データをロード
2. データをインクリメント、デクリメント
3. データをストア

---

%large: 内部命令

---


| ニーモニック | 動作                           | コード   |
|--------------|--------------------------------|----------|
| LD           | データをロード                 | `00000011` |
| ST           | データをストア                 | `00000001` |
| INC          | データをインクリメント         | `00010000` |
| DEC          | データをデクリメント           | `00100000` |
| FW           | データポインタをインクリメント | `00000100` |
| BW           | データポインタをデクリメント   | `00001000` |
| LDJT         | ジャンプテーブルをロード(*)    | `00000010` |
| STJT         | ジャンプテーブルをストア(*)    | `00110000` |
| JPZ          | データが0ならジャンプ          | `00001100` |
| OUT          | データを出力                   | `01000000` |
| IN           | 入力からデータにストア         | `10000000` |

---

%large: 命令変換テーブル

---

| アドレス | インストラクション | 内部命令 |
|----------|--------------------|----------|
| 0x01     | >                  | FW       |
| 0x02     | <                  | BW       |
| 0x03     | +                  | LD       |
| 0x04     |                    | INC      |
| 0x05     |                    | ST       |
| 0x06     | -                  | LD       |
| 0x07     |                    | DEC      |
| 0x08     |                    | ST       |
| 0x09     | .                  | OUT      |
| 0x0a     | ,                  | IN       |
| 0x0b     | [                  | LDJT     |
| 0x0c     |                    | JPZ      |
| 0x0d     | ]                  | LDJT     |
| 0x0e     |                    | JPZ      |

---

![middle](in-inst-table.png)

---

%large: デコーダー

## Brainf\*ckインストラクション

| インストラクション | 内部命令  | コード |
|--------------------|-----------|--------|
| >                  | FW        | 0x11   |
| <                  | BW        | 0x12   |
| +                  | LD,INC,ST | 0x33   |
| -                  | LD,DEC,ST | 0x36   |
| .                  | OUT       | 0x2a   |
| ,                  | IN        | 0x1b   |
| [                  | LD,JPZ    | 0x2c   |
| ]                  | LD,JPZ    | 0x2e   |

---

![large](decoder.png)

## `.` `,`

* データを出力ポートに出力
* 入力ポートからデータをストア
  * 入力待ちが発生するので空回りさせる

## `[` `]`

1. データをロード
2. データが0ならばジャンプテーブルからプログラムカウンタへロード

## ジャンプテーブル

* `[`,`]`の対応付けをするためにあらかじめ作っておく必要がある。
* スタックを作っておいて起動後にプログラムを一周読んでジャンプテーブルをつくる

---

%huge: 言い訳

## 何故？完成しなかったか？

あるいは、TD4に比べてどこがむずかしいのか

* 内部命令テーブルが必要ということ
* メモリのリード/ライトが必要
  * TD4は制御方向が一方向
  * BF machineはフェッチフェーズと命令実行フェーズがある
* マイコンを挟んだためタイミングが微妙なところがある

## この先やりたいこと

* 完成させる
* 入出力
* プリント基盤とキット化
* アドレスバスの16bit化
  * 30000以上のデータ配列サイズ(2^16=65536)
* メモリを実メモリで実装
  * メモリの取り扱いは難しい＞＜

## まとめ

* TD4を参考にBrainf\*ck machineの設計をしました。
* まだデコーダー部しか動いていません。
* 完成したらまたどこかで発表したいです。

---

%large: ブログ書きます。([Retrieva TECH BLOG](https://tech.retrieva.jp/))

---

---
